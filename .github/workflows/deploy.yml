name: Deploy Pipeline

on:
  push:
    branches:
      - main
      - develop
      - driver-socket

  workflow_dispatch:

jobs:

  #######################################################################
  # 1) Deploy to EC2 (runs on ALL 3 branches depending on config)
  #######################################################################
  deploy-to-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    if: secrets.AWS_ACCESS_KEY_ID && (
         github.ref == 'refs/heads/develop' ||
         github.ref == 'refs/heads/main' ||
         github.ref == 'refs/heads/driver-socket'
       )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Determine EC2 target
        id: ec2-target
        run: |
          BRANCH="${GITHUB_REF##*/}"

          if [[ "$BRANCH" == "main" ]]; then
            echo "instance=${{ secrets.EC2_PRODUCTION_INSTANCE_ID }}" >> $GITHUB_OUTPUT
            echo "host=${{ secrets.EC2_PRODUCTION_HOST }}" >> $GITHUB_OUTPUT
          else
            echo "instance=${{ secrets.EC2_STAGING_INSTANCE_ID }}" >> $GITHUB_OUTPUT
            echo "host=${{ secrets.EC2_STAGING_HOST }}" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to EC2 via SSM
        run: |
          INSTANCE="${{ steps.ec2-target.outputs.instance }}"
          APP_DIR="${{ secrets.EC2_APP_DIRECTORY }}"

          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "$INSTANCE" \
            --parameters commands="[
              'cd $APP_DIR',
              'git pull',
              'npm ci --production',
              'npm run build',
              'pm2 restart transit-driver || pm2 start dist/app.js --name transit-driver'
            ]"

  #######################################################################
  # 2) Elastic Beanstalk Deployment (Staging) → driver-socket branch
  #######################################################################
  eb-staging:
    name: Deploy EB Staging
    runs-on: ubuntu-latest
    if: secrets.AWS_ACCESS_KEY_ID && github.ref == 'refs/heads/driver-socket'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Package app for EB
        run: |
          mkdir deploy
          cp -r dist deploy/
          cp -r .ebextensions deploy/
          cp package.json package-lock.json deploy/
          cp Procfile deploy/ || true
          cd deploy
          zip -r ../deploy.zip .
          cd ..

      - name: Upload to EB + Release
        run: |
          APP="${{ secrets.EB_APPLICATION_NAME }}"
          ENV="${{ secrets.EB_STAGING_ENV }}"
          BUCKET="${{ secrets.EB_S3_BUCKET }}"
          VERSION="staging-$(date +%Y%m%d-%H%M%S)"

          aws s3 cp deploy.zip s3://$BUCKET/$VERSION.zip

          aws elasticbeanstalk create-application-version \
            --application-name "$APP" \
            --version-label "$VERSION" \
            --source-bundle S3Bucket="$BUCKET",S3Key="$VERSION.zip"

          aws elasticbeanstalk update-environment \
            --application-name "$APP" \
            --environment-name "$ENV" \
            --version-label "$VERSION"

  #######################################################################
  # 3) Elastic Beanstalk Deployment (Production) → main branch
  #######################################################################
  eb-prod:
    name: Deploy EB Production
    runs-on: ubuntu-latest
    if: secrets.AWS_ACCESS_KEY_ID && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Package app for EB
        run: |
          mkdir deploy
          cp -r dist deploy/
          cp package.json package-lock.json deploy/
          cp -r .ebextensions deploy/
          cp Procfile deploy/ || true
          cd deploy
          zip -r ../deploy.zip .
          cd ..

      - name: Upload & Deploy EB Prod
        run: |
          APP="${{ secrets.EB_APPLICATION_NAME }}"
          ENV="${{ secrets.EB_PRODUCTION_ENV }}"
          BUCKET="${{ secrets.EB_S3_BUCKET }}"
          VERSION="prod-$(date +%Y%m%d-%H%M%S)"

          aws s3 cp deploy.zip s3://$BUCKET/$VERSION.zip

          aws elasticbeanstalk create-application-version \
            --application-name "$APP" \
            --version-label "$VERSION" \
            --source-bundle S3Bucket="$BUCKET",S3Key="$VERSION.zip"

          aws elasticbeanstalk update-environment \
            --environment-name "$ENV" \
            --version-label "$VERSION"

  #######################################################################
  # 4) Render Deploy (Only on driver-socket)
  #######################################################################
  render-deploy:
    name: Deploy Render (driver-socket)
    runs-on: ubuntu-latest
    if: secrets.RENDER_API_KEY && github.ref == 'refs/heads/driver-socket'

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Render
        uses: johnbeynon/render-deploy@v0.0.15
        with:
          service-id: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
