// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  name                String?
  password            String
  emailVerified       Boolean   @default(false)
  image               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  phoneNumber         String?   @unique
  phoneNumberVerified Boolean?  @default(false)
  gender              String?
  dob                 DateTime?
  passport            String?
  resetToken          String?
  resetTokenExpiresAt DateTime?
  isDriver            Boolean   @default(false)
  isAdmin             Boolean   @default(false)
  fcmToken            String?

  // Referral fields (for riders)
  referralCode     String? @unique // Unique code for sharing (e.g. RDR-XXXX)
  referredByUserId String?
  referredByUser   User?   @relation("UserReferral", fields: [referredByUserId], references: [id])
  referredUsers    User[]  @relation("UserReferral")

  sessions          Session[]
  accounts          Account[]
  bookings          Booking[]          @relation("BookingUser")
  driver            Driver?            @relation("DriverUser")
  rides             Ride[]             @relation("RideRider")
  payments          Payment[]          @relation("PaymentRider")
  wallet            Wallet?
  favoriteLocations FavoriteLocation[]
  emergencyContacts EmergencyContact[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model Otp {
  id          String   @id @default(cuid())
  phoneNumber String
  otp         String
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@map("otp")
}

// Cab Related schema
model Booking {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  orderRefId String?  @unique
  status     String
  otp        String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Associations
  userId   String?
  user     User?   @relation("BookingUser", fields: [userId], references: [id])
  cabId    String?
  cab      Cab?    @relation(fields: [cabId], references: [id])
  driverId String?
  driver   Driver? @relation(fields: [driverId], references: [id])

  // Trip details
  tripType          String?
  tripDescription   String?
  estimatedDuration Int?
  distance          Float?

  // Location details
  pickupLatitude  Float?
  pickupLongitude Float?
  dropLatitude    Float?
  dropLongitude   Float?

  // Cancellation details
  cancellationReason  String?
  cancellationCharge  Float?
  refundAmount        Float?
  cancellationMessage String?

  // Fare Breakup
  fare Fare?

  // Relations from transit_driver
  rideRequest RideRequest?

  @@map("booking")
}

model Cab {
  id          String   @id @default(cuid())
  cabId       Int      @unique
  model       String?
  number      String? // Vehicle number
  hasCNG      Boolean  @default(false)
  hasElectric Boolean  @default(false)
  roofTop     Boolean  @default(false)
  isAttached  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  // Vehicle information
  brand                  String?
  year                   Int?
  fuelType               String?
  seatingCapacity        Int?
  licensePlate           String[]
  insuranceStatus        Boolean   @default(false)
  insuranceExpiryDate    DateTime?
  registrationExpiryDate DateTime?
  cabImages              Json? // Will store { cover: string[], interior: string[], exterior: string[] }

  // Update cab location
  lastLatitude  String?
  lastLongitude String?

  // Trip data
  status        String    @default("awaited")
  tripStartDate DateTime?
  tripStartTime String?
  tripEndDate   DateTime?
  tripEndTime   String?

  bookings Booking[]

  // Relationship with driver
  driver   Driver? @relation(fields: [driverId], references: [id])
  driverId String? @unique

  @@map("cab")
}

model Driver {
  id            String  @id @default(cuid())
  name          String
  provider      String?
  contactCode   String?
  contactNumber String? // Can be used by transit_backend

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  // Driver verification and onboarding fields
  // Email, password, phoneNumber come from User table - no duplication!
  userId            String  @unique // REQUIRED: Driver MUST be linked to a User account
  user              User    @relation("DriverUser", fields: [userId], references: [id], onDelete: Cascade)
  isVerified        Boolean @default(false) // Whether driver is verified
  approvalStatus    String  @default("PENDING") // PENDING, APPROVED, REJECTED, SUSPENDED
  drivingExperience Int?    @default(0) // Years of driving experience
  averageRating     Float   @default(0)
  totalRatings      Int     @default(0)
  accountActive     Boolean @default(false)
  rejectionReason   String? // Reason if driver was rejected
  suspensionReason  String? // Reason if driver was suspended

  // Driver's Government IDs
  aadharNumber String?
  panNumber    String?
  fcmToken     String?

  // Real-time location fields
  currentLat Float?
  currentLng Float?

  // Relations from transit_backend
  bookings             Booking[]
  documents            DriverDocument[]
  DriverSubscription   DriverSubscription[]
  SubscriptionPayments SubscriptionPayment[]
  cab                  Cab?
  rides                Ride[]
  vehicle              Vehicle[]
  rideOffers           RideOffer[]           @relation("RideOffers")

  // Referral fields
  referralCode       String?  @unique // Unique code for sharing (e.g. DRV-XXXX)
  referredByDriverId String?
  referredByDriver   Driver?  @relation("DriverReferral", fields: [referredByDriverId], references: [id])
  referredDrivers    Driver[] @relation("DriverReferral")

  // Relations from transit_driver
  driverDetails       DriverDetails?
  driverLocation      DriverLocation?
  driverStatus        DriverStatus?
  driverWallet        DriverWallet?
  payments            Payment[]
  rideRequests        DriverRideRequests[]
  assignedRides       RideRequest[]              @relation("AssignedDriver")
  emergencyContacts   DriverEmergencyContact[]
  cancellationStrikes DriverCancellationStrike[]
  validReasonCancels  DriverValidReasonCancel[]

  // Indexes for better query performance
  @@index([userId])
  @@map("driver")
}

model DriverDocument {
  id       String @id @default(cuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  documentType      String // DRIVING_LICENSE, VEHICLE_REGISTRATION, INSURANCE etc.
  documentNumber    String?
  documentUrl       String // URL to the document in storage
  expiryDate        DateTime?
  isVerified        Boolean   @default(false)
  verificationNotes String?
  uploadDate        DateTime  @default(now())
  verifiedDate      DateTime?

  @@map("driver_document")
}

//subsciption model for driver
model DriverSubscription {
  id         String       @id @default(cuid())
  driverId   String
  driver     Driver       @relation(fields: [driverId], references: [id], onDelete: Cascade)
  startTime  DateTime
  expire     DateTime
  amountPaid Float
  status     statusDriver // ACTIVE, EXPIRED, CANCELLED
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @default(now())

  paymentId   String?
  paymentMode String?

  autoRenewed Boolean @default(false)

  //track remaining time if subscription is paused
  remainingMinutes Int?

  // Per-day cap (minutes). Continuous countdown from first online that day. null = no daily cap.
  dailyAllowanceMinutes Int?

  // Overtime billing: when subscription expires, we charge ₹10/hr. Last time we applied overtime charge.
  lastOvertimeBillingAt DateTime?

  @@index([driverId])
  @@index([status, expire])
}

enum statusDriver {
  ACTIVE
  EXPIRED
  CANCELLED
}

// payment transaction model to track payments
model SubscriptionPayment {
  id               String   @id @default(cuid())
  driverId         String
  driver           Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  amount           Float // Full subscription price
  walletAmountUsed Float    @default(0) // Amount deducted from driver wallet
  paymentMode      String
  transactionId    String?
  status           String // SUCCESS, FAILED, PENDING
  createdAt        DateTime @default(now())

  @@index([driverId])
}

model Fare {
  id        String   @id @default(cuid())
  bookingId String   @unique
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  // Core fare components
  baseFare    Float
  totalAmount Float
  dueAmount   Float
  advancePaid Float

  // All taxes and fees combined (GST, state tax, etc.)
  taxes Float

  // Additional charges
  tollCharges       Float @default(0)
  parkingCharges    Float @default(0)
  driverAllowance   Float @default(0)
  airportFees       Float @default(0)
  additionalCharges Float @default(0)
  addonCharges      Float @default(0)

  // Discounts
  discount Float @default(0)

  @@map("fare")
}

model Vehicle {
  id                 String          @id @default(cuid())
  make               String
  model              String
  year               Int
  color              String?
  licensePlate       String          @unique
  vehicleType        String // e.g., "sedan", "suv", "hatchback"
  hasCNG             Boolean         @default(false)
  hasElectric        Boolean         @default(false)
  fuelType           String?
  seatingCapacity    Int?
  insuranceStatus    Boolean         @default(false)
  insuranceExpiry    DateTime?
  registrationExpiry DateTime?
  vehicleImages      Json? // { cover: string[], interior: string[], exterior: string[] }
  isActive           Boolean         @default(true)
  isAvailable        Boolean         @default(true)
  driverId           String          @unique
  driver             Driver          @relation(fields: [driverId], references: [id])
  driverLocation     DriverLocation? // Relation from DriverLocation
  rides              Ride[]
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

model ServiceZone {
  id              String   @id @default(cuid())
  name            String
  city            String
  country         String   @default("India")
  boundary        Json // Polygon or geojson
  baseFare        Float
  perKmRate       Float
  perMinRate      Float
  minFare         Float
  maxFare         Float?
  surgeMultiplier Float    @default(1.0)
  isActive        Boolean  @default(true)
  rides           Ride[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Ride {
  id                 String    @id @default(cuid())
  rideCode           String    @unique // Human-readable code for reference (optional)
  status             String // "pending", "accepted", "in_progress", "completed", "cancelled"
  pickupLatitude     Float
  pickupLongitude    Float
  pickupAddress      String?
  dropLatitude       Float?
  dropLongitude      Float?
  dropAddress        String?
  startTime          DateTime?
  endTime            DateTime?
  estimatedFare      Float?
  actualFare         Float?
  estimatedDistance  Float?
  actualDistance     Float?
  estimatedDuration  Int? // in minutes
  actualDuration     Int? // in minutes
  baseFare           Float?
  surgeMultiplier    Float     @default(1.0)
  waitingTime        Int? // in minutes
  cancellationFee    Float?
  cancellationReason String?
  cancelledBy        String? // "user", "driver", "system", "admin"
  cancelledAt        DateTime? // When the ride was cancelled
  paymentStatus      String? // "pending", "paid", "failed", etc.
  paymentMethod      String? // "cash", "wallet", "card", etc.
  transactionId      String? // Payment gateway reference

  // Rating and review
  rating  Float? // Rating from 1 to 5
  comment String? // Optional review comment from rider

  // Relations
  // driverId is nullable until a driver is assigned (broadcast-first flow)
  driverId      String?
  driver        Driver?      @relation(fields: [driverId], references: [id])
  riderId       String
  rider         User         @relation("RideRider", fields: [riderId], references: [id])
  vehicleId     String?
  vehicle       Vehicle?     @relation(fields: [vehicleId], references: [id])
  serviceZoneId String?
  serviceZone   ServiceZone? @relation(fields: [serviceZoneId], references: [id])

  // Route and tracking
  route                 Json? // Polyline or array of coordinates
  waypoints             Json? // Intermediate stops [{latitude, longitude, address, order}]
  isRoundTrip           Boolean @default(false) // Go to drop, then return to pickup (Ola/Uber style)
  returnTimeMinutes     Int? // Wait at destination before return (30, 60, 120 min)
  driverLocationUpdates Json? // Array of {lat, lng, timestamp}

  // Rider's selected vehicle type (from rider backend; must match rider schema for shared DB)
  requestedVehicleType String? // e.g. "sedan", "suv", "auto", "hatchback"

  // Book for someone else (rider booking on behalf of another person)
  bookingForName  String? // Name of person riding
  bookingForPhone String? // Phone of person riding (for driver contact)

  // Scheduled/Advance booking
  isScheduled         Boolean   @default(false)
  scheduledPickupTime DateTime? // For advance bookings
  scheduledAt         DateTime? // When the ride was scheduled

  // Ride OTP for security (generated when driver accepts, verified before ride starts)
  rideOtp String? // 4-digit OTP for ride verification (no expiration)

  // Driver location at accept – for 1 km cancellation rule (rider cannot cancel after driver has travelled 1 km towards pickup)
  driverAcceptedAt  DateTime?
  driverLatAtAccept Float?
  driverLngAtAccept Float?

  // Waiting time at pickup: driver arrived till OTP entered (first 3 min free; then ₹1/min 6–22, ₹1.5/min 22–6)
  driverArrivedAtPickupAt DateTime?
  waitingCharges          Float? // in rupees

  // Driver cancellation policy: outcome fields
  driverStrikeType             String? // "full" | "light" | null
  driverCompensationAmount     Float? // amount credited to driver
  driverCancellationReasonType String? // "vehicle_breakdown" | "accident" | "medical_emergency" | "unsafe_pickup" | "road_blockage" | null
  riderCallAttemptedAt         DateTime? // when driver first attempted in-app call (for no-show rule)

  // Timestamps
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  payments     Payment[]
  rideOffers   RideOffer[]
  chatMessages ChatMessage[]

  @@index([status, createdAt])
  @@index([driverId, status])
  @@index([riderId, status])
  @@index([serviceZoneId])
  @@index([driverId, status, rating]) // For rating queries
}

model ChatMessage {
  id         String   @id @default(cuid())
  rideId     String
  ride       Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
  senderId   String // driver or rider user id
  senderType String // "driver" | "rider"
  text       String   @db.Text
  createdAt  DateTime @default(now())

  @@index([rideId, createdAt])
}

// Ride offers - tracks which drivers are offered a ride
model RideOffer {
  id          String    @id @default(cuid())
  rideId      String
  ride        Ride      @relation(fields: [rideId], references: [id], onDelete: Cascade)
  driverId    String
  driver      Driver    @relation("RideOffers", fields: [driverId], references: [id], onDelete: Cascade)
  status      String    @default("pending") // pending, accepted, rejected, expired
  offeredAt   DateTime  @default(now())
  respondedAt DateTime?
  expiresAt   DateTime // 45 seconds from now

  @@index([rideId])
  @@index([driverId, status])
  @@index([rideId, status])
}

// Payment model for ride payments
model Payment {
  id                String  @id @default(cuid())
  amount            Float
  status            String // "pending", "completed", "failed", "refunded"
  paymentMethod     String // "credit_card", "debit_card", "cash", "wallet", "upi"
  transactionId     String? @unique
  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?
  currency          String  @default("INR")
  description       String?
  metadata          Json? // Additional payment details

  // Ride relation
  ride   Ride   @relation(fields: [rideId], references: [id])
  rideId String @unique

  // Rider relation
  rider   User   @relation("PaymentRider", fields: [riderId], references: [id])
  riderId String

  // Driver relation
  driver   Driver? @relation(fields: [driverId], references: [id])
  driverId String?

  // Refund details
  refundReason String?
  refundedAt   DateTime?
  refundAmount Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([riderId, status])
  @@index([driverId, status])
  @@index([rideId])
  @@index([transactionId])
}

// Wallet model for riders
model Wallet {
  id       String @id @default(cuid())
  balance  Float  @default(0)
  currency String @default("INR")

  // Rider relation
  rider   User   @relation(fields: [riderId], references: [id], onDelete: Cascade)
  riderId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions WalletTransaction[]

  @@map("wallet")
}

// Wallet transaction history
model WalletTransaction {
  id            String  @id @default(cuid())
  type          String // "credit", "debit"
  amount        Float
  balanceBefore Float
  balanceAfter  Float
  description   String?
  referenceType String? // "ride_payment", "refund", "topup", "refund_cancellation"
  referenceId   String? // ID of related entity (rideId, paymentId, etc.)

  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  walletId String

  createdAt DateTime @default(now())

  @@index([walletId, createdAt])
  @@index([referenceType, referenceId])
  @@map("wallet_transaction")
}

// Driver wallet (shared DB with transit_driver)
model DriverWallet {
  id        String   @id @default(cuid())
  driverId  String   @unique
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  balance   Float    @default(0)
  currency  String   @default("INR")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions DriverWalletTransaction[]

  @@map("driver_wallet")
}

model DriverWalletTransaction {
  id             String       @id @default(cuid())
  driverWalletId String
  driverWallet   DriverWallet @relation(fields: [driverWalletId], references: [id], onDelete: Cascade)
  type           String // "credit" | "debit"
  amount         Float
  balanceBefore  Float
  balanceAfter   Float
  description    String?
  referenceType  String? // "referral_referrer" | "referral_referee" | "subscription"
  referenceId    String? // e.g. subscriptionPaymentId, referralCreditId
  createdAt      DateTime     @default(now())

  @@index([driverWalletId, createdAt])
  @@map("driver_wallet_transaction")
}

// Favorite locations for riders
model FavoriteLocation {
  id        String  @id @default(cuid())
  name      String // "Home", "Work", "Custom name"
  address   String
  latitude  Float
  longitude Float
  type      String? // "home", "work", "custom"

  // Rider relation
  rider   User   @relation(fields: [riderId], references: [id], onDelete: Cascade)
  riderId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([riderId])
  @@map("favorite_location")
}

// Emergency contacts for riders
model EmergencyContact {
  id           String  @id @default(cuid())
  name         String
  phoneNumber  String
  relationship String? // "family", "friend", "other"

  // Rider relation
  rider   User   @relation(fields: [riderId], references: [id], onDelete: Cascade)
  riderId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([riderId])
  @@map("emergency_contact")
}

// ONDC Reconciliation Models
model OndcReconciliation {
  id            String   @id @default(cuid())
  transactionId String   @unique
  bppId         String
  bppUri        String
  status        String // PENDING, COMPLETED, FAILED
  totalAmount   Decimal?
  currency      String   @default("INR")

  // Legacy DB column retained for compatibility; ignored by Prisma Client
  ordersLegacy Json? @map("orders") @ignore

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders OndcReconciliationOrder[]

  @@index([status, createdAt])
  @@map("ondcReconciliation")
}

model OndcReconciliationOrder {
  id               String  @id @default(cuid())
  reconciliationId String
  orderId          String
  amount           Decimal
  currency         String  @default("INR")
  status           String // PENDING, COMPLETED, FAILED

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  reconciliation OndcReconciliation             @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  settlements    OndcReconciliationSettlement[]

  @@index([reconciliationId])
  @@index([orderId])
}

model OndcReconciliationSettlement {
  id           String  @id @default(cuid())
  orderId      String
  settlementId String
  paymentId    String
  amount       Decimal
  currency     String  @default("INR")
  status       String // PENDING, COMPLETED, FAILED

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order OndcReconciliationOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([settlementId])
}

// Driver-specific models (from transit_driver)
model DriverDetails {
  id                    String    @id @default(cuid())
  driver                Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)
  driverId              String    @unique
  licenseNumber         String    @unique
  isAvailable           Boolean   @default(false)
  isVerified            Boolean   @default(false)
  rating                Float     @default(0)
  totalRides            Int       @default(0)
  totalEarnings         Float     @default(0)
  profileImage          String?
  /// Daily verification selfie (replaced each day). For admin review; profile photo stays unchanged.
  verificationSelfieUrl String?
  dateOfBirth           DateTime?
  gender                String?
  address               String?
  city                  String?
  state                 String?
  country               String    @default("India")
  bankDetails           Json? // Store encrypted bank account details
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([isAvailable, isVerified])
  @@index([city, isAvailable])
}

// Real-time driver location tracking (transit_driver)
model DriverLocation {
  id        String   @id @default(cuid())
  driverId  String   @unique
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicleId String?  @unique
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])

  // Location data
  latitude  Float
  longitude Float

  // Metadata
  timestamp DateTime @default(now())

  // Status context
  isOnline    Boolean @default(true)
  isAvailable Boolean @default(true)
  isInTrip    Boolean @default(false)

  // For optimizing nearest driver queries
  lastUpdatedAt DateTime @default(now()) @updatedAt

  @@index([driverId, timestamp])
  @@index([latitude, longitude])
  @@index([timestamp])
  @@index([isOnline, isAvailable])
  @@map("driver_location")
}

// Driver status enum (transit_driver)
enum DriverStatusType {
  OFFLINE
  ONLINE
  BUSY
  BREAK
}

// Driver availability and status tracking (transit_driver)
model DriverStatus {
  id       String @id @default(cuid())
  driverId String @unique
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  status             DriverStatusType @default(OFFLINE)
  lastPingAt         DateTime         @default(now())
  totalOnlineHours   Float            @default(0)
  // First time driver went online this calendar day (UTC). Used for continuous daily allowance countdown.
  firstOnlineAtToday DateTime?
  // When current online session started. Auto-offline after 12h for safety.
  sessionStartedAt   DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@map("driver_status")
}

// Ride request and matching system (transit_driver)
model RideRequest {
  id        String @id @default(cuid())
  requestId String @unique @default(cuid())

  // Rider relation (riderId is external reference to User.id from transit_backend)
  // NOTE: RiderInfo model exists for schema consistency, but records are never created.
  // RideRequest.riderId directly references User.id from transit_backend.
  riderId String

  // Trip details
  pickupLatitude  Float
  pickupLongitude Float
  pickupAddress   String?
  dropLatitude    Float?
  dropLongitude   Float?
  dropAddress     String?

  // Request parameters
  rideType          String @default("STANDARD")
  maxWaitTime       Int    @default(300)
  estimatedDistance Float?
  estimatedDuration Int?
  estimatedFare     Float?

  // Status and lifecycle
  status      String   @default("PENDING")
  requestedAt DateTime @default(now())
  expiresAt   DateTime

  // Matching details
  assignedDriverId String?
  assignedDriver   Driver?   @relation("AssignedDriver", fields: [assignedDriverId], references: [id])
  matchedAt        DateTime?
  acceptedAt       DateTime?

  // Cancellation
  cancelledAt        DateTime?
  cancellationReason String?
  cancelledBy        String?

  // Final booking reference
  bookingId String?  @unique
  booking   Booking? @relation(fields: [bookingId], references: [id])

  // Broadcast tracking
  driverRequests DriverRideRequests[]

  @@index([status, requestedAt])
  @@index([pickupLatitude, pickupLongitude])
  @@index([riderId, status])
  @@index([requestedAt])
  @@map("ride_request")
}

// Track which drivers received specific ride requests (transit_driver)
model DriverRideRequests {
  id            String      @id @default(cuid())
  driverId      String
  driver        Driver      @relation(fields: [driverId], references: [id], onDelete: Cascade)
  rideRequestId String
  rideRequest   RideRequest @relation(fields: [rideRequestId], references: [id], onDelete: Cascade)

  sentAt      DateTime  @default(now())
  receivedAt  DateTime?
  respondedAt DateTime?
  response    String?

  distanceToPickup Float?
  etaToPickup      Int?
  rejectionReason  String?

  @@unique([driverId, rideRequestId])
  @@index([rideRequestId, sentAt])
  @@map("driver_ride_requests")
}

// Emergency contacts for drivers (SOS and safety)
model DriverEmergencyContact {
  id           String   @id @default(cuid())
  name         String
  phoneNumber  String
  relationship String? // "family", "friend", "other"
  driverId     String
  driver       Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([driverId])
  @@map("driver_emergency_contact")
}

model DriverCancellationStrike {
  id          String   @id @default(cuid())
  driverId    String
  driver      Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  rideId      String
  strikeType  String // "full" | "light"
  cancelledAt DateTime
  createdAt   DateTime @default(now())

  @@index([driverId, createdAt])
  @@map("driver_cancellation_strike")
}

model DriverValidReasonCancel {
  id          String   @id @default(cuid())
  driverId    String
  driver      Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  rideId      String
  reasonType  String
  cancelledAt DateTime
  createdAt   DateTime @default(now())

  @@index([driverId, cancelledAt])
  @@map("driver_valid_reason_cancel")
}

// Tracks that referral credit was given for a referee's first subscription (avoid double credit)
model ReferralCredit {
  id                    String   @id @default(cuid())
  refereeDriverId       String // Driver who bought subscription
  referrerDriverId      String // Driver who referred them
  subscriptionPaymentId String
  createdAt             DateTime @default(now())

  @@unique([refereeDriverId])
  @@map("referral_credit")
}

// Tracks that referral credit was given for a rider's first ride (avoid double credit)
model RiderReferralCredit {
  id             String   @id @default(cuid())
  refereeUserId  String // Rider who completed first ride
  referrerUserId String // Rider who referred them
  rideId         String // First completed ride
  createdAt      DateTime @default(now())

  @@unique([refereeUserId])
  @@map("rider_referral_credit")
}

// Rider info model for tracking rider details (transit_driver)
// NOTE: This model exists in schema but records are never created.
// RideRequest.riderId is an external reference to User.id from transit_backend.
// The RiderInfo model is kept for potential future use but currently unused.
model RiderInfo {
  id           String  @id @default(cuid())
  riderId      String  @unique // External reference to User.id from transit_backend
  firstName    String
  lastName     String
  phoneNumber  String
  profileImage String?
  rating       Float   @default(0)
  totalRides   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([riderId])
  @@index([phoneNumber])
  @@map("rider_info")
}
